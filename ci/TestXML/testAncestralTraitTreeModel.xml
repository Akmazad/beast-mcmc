<?xml version="1.0" standalone="yes"?>
<beast>

	<taxa id="taxa">
		<taxon id="A">
			<attr name="X">10</attr>
		</taxon>
		<taxon id="B">
			<attr name="X">2</attr>
		</taxon>
		<taxon id="C">
			<attr name="X">3</attr>
		</taxon>
	</taxa>

	<taxa id="ancestors">
		<taxon id="mrcaAB_taxon">
			<attr name="X">5</attr>
			<!-- <attr name="pseudoBranchLength">100.0</attr> -->
		</taxon>
		<taxon id="mrcaABC_taxon">
			<attr name="X">10</attr>
			<!-- <attr name="pseudoBranchLength">100.0</attr> -->
		</taxon>
	</taxa>

	<newick id="tree">
		((A:1,B:1):1,C:2);
	</newick>

	<treeModel id="treeModel">
		<newick idref="tree"/>
		<rootHeight>
			<parameter id="treeModel.rootHeight"/>
		</rootHeight>
		<nodeHeights internalNodes="true">
			<parameter id="treeModel.internalNodeHeights"/>
		</nodeHeights>
		<nodeHeights internalNodes="true" rootNode="true">
			<parameter id="treeModel.allInternalNodeHeights"/>
		</nodeHeights>
		<nodeTraits name="X" rootNode="false" internalNodes="false" leafNodes="true" traitDimension="1">
			<parameter id="leafTraits"/>
		</nodeTraits>
	</treeModel>

	<ancestralTraitTreeModel id="ancestralTraitTreeModel">
		<treeModel idref="treeModel"/>
		<ancestor>
			<taxon idref="mrcaAB_taxon"/>
			<parameter id="pseudoBranchLengthAB" value="0.01" lower="0.0"/>
            <mrca>
                <taxa id="mrcaAB">
                    <taxon idref="A"/>
                    <taxon idref="B"/>
                </taxa>
			</mrca>
		</ancestor>
		<ancestor>
			<taxon idref="mrcaABC_taxon"/>
			<parameter id="pseudoBranchLengthABC" value="0.01" lower="0.0"/>
			<mrca>
                <taxa id="mrcaABC">
                    <taxon idref="A"/>
                    <taxon idref="B"/>
                    <taxon idref="C"/>
                </taxa>
			</mrca>
		</ancestor>

		<nodeTraits name="X" rootNode="false" internalNodes="false" leafNodes="true" traitDimension="1">
			<parameter id="leafAndAncestorTraits"/>
		</nodeTraits>
	</ancestralTraitTreeModel>

	<report>
        Tree : 
		<treeModel idref="treeModel"/>
	</report>
	<report>
        Ancestral Tree : 
		<ancestralTraitTreeModel idref="ancestralTraitTreeModel"/>
	</report>

	<restrictedPartials id="restrictedPartials1">
		<treeModel idref="treeModel"/>
		<mrca>
			<taxon idref="A"/>
			<taxon idref="B"/>
		</mrca>
		<meanParameter>
			<parameter value="5.0"/>
		</meanParameter>
		<priorSampleSize>
			<parameter value="100.0"/>
		</priorSampleSize>
	</restrictedPartials>

	<restrictedPartials id="restrictedPartials2">
		<treeModel idref="treeModel"/>
		<mrca>
			<taxon idref="A"/>
			<taxon idref="B"/>
			<taxon idref="C"/>
		</mrca>
		<meanParameter>
			<parameter value="10.0"/>
		</meanParameter>
		<priorSampleSize>
			<parameter value="100.0"/>
		</priorSampleSize>
	</restrictedPartials>

	<monophylyStatistic id="monophyly(mrcaAB)">
		<mrca>
			<taxa idref="mrcaAB"/>
		</mrca>
		<treeModel idref="treeModel"/>
	</monophylyStatistic>

    <multivariateDiffusionModel id="diffusionModel">
		<precisionMatrix>
			<matrixParameter id="precisionMatrix">
				<parameter id="prec.col1" value="1.0"/>
			</matrixParameter>
		</precisionMatrix>
	</multivariateDiffusionModel>

	<discretizedBranchRates id="diffusionRates">
		<treeModel idref="treeModel"/>
		<distribution>
			<logNormalDistributionModel meanInRealSpace="true">
				<mean>
					<parameter value="1.0"/>
				</mean>
				<stdev>
					<parameter id="stdev" value="1.0" lower="0.0"/>
				</stdev>
			</logNormalDistributionModel>
		</distribution>
		<rateCategories>
			<parameter id="rrwCategories"/>
		</rateCategories>
	</discretizedBranchRates>

	<ancestralTraitBranchRates id="ancestralTraitTreeDiffusionRates">
		<ancestralTraitTreeModel idref="ancestralTraitTreeModel"/>
        <discretizedBranchRates idref="diffusionRates"/>
	</ancestralTraitBranchRates>

	<multivariateTraitLikelihood id="oldVanillaLikelihood" traitName="X" integrateInternalTraits="true">
		<multivariateDiffusionModel idref="diffusionModel"/>
		<treeModel idref="treeModel"/>
		<traitParameter>
			<parameter idref="leafTraits"/>
		</traitParameter>
        <conjugateRootPrior>
            <meanParameter>
                <parameter value="0.0"/>
            </meanParameter>
            <priorSampleSize>
                <parameter value="100000.0"/>
            </priorSampleSize>
        </conjugateRootPrior>
        <discretizedBranchRates idref="diffusionRates"/>
	</multivariateTraitLikelihood>

	<report>
		Old vanilla =
		<multivariateTraitLikelihood idref="oldVanillaLikelihood"/>
	</report>

	<multivariateTraitLikelihood id="oldRestrictedLikelihood" traitName="X" integrateInternalTraits="true">
		<multivariateDiffusionModel idref="diffusionModel"/>
		<treeModel idref="treeModel"/>
		<traitParameter>
			<parameter idref="leafTraits"/>
		</traitParameter>
        <conjugateRootPrior>
            <meanParameter>
                <parameter value="0.0"/>
            </meanParameter>
            <priorSampleSize>
                <parameter value="100000.0"/>
            </priorSampleSize>
        </conjugateRootPrior>
        <restrictedPartials idref="restrictedPartials1"/>
        <restrictedPartials idref="restrictedPartials2"/>
        <discretizedBranchRates idref="diffusionRates"/>
	</multivariateTraitLikelihood>

	<report>
		Old restricted =
		<multivariateTraitLikelihood idref="oldRestrictedLikelihood"/>
	</report>

	<traitDataLikelihood id="newVanillaLikelihood" traitName="X" forceFullPrecision="false">
		<multivariateDiffusionModel idref="diffusionModel"/>
		<treeModel idref="treeModel"/>
		<traitParameter>
			<parameter idref="leafTraits"/>
		</traitParameter>
        <conjugateRootPrior>
            <meanParameter>
                <parameter value="0.0"/>
            </meanParameter>
            <priorSampleSize>
                <parameter value="100000.0"/>
            </priorSampleSize>
        </conjugateRootPrior>
        <discretizedBranchRates idref="diffusionRates"/>
	</traitDataLikelihood>

	<report>
		New vanilla =
		<traitDataLikelihood idref="newVanillaLikelihood"/>
	</report>

	<traitDataLikelihood id="newRestrictedLikelihood" traitName="X">
		<multivariateDiffusionModel idref="diffusionModel"/>
		<ancestralTraitTreeModel idref="ancestralTraitTreeModel"/>
		<traitParameter>
			<parameter idref="leafAndAncestorTraits"/>
		</traitParameter>
        <conjugateRootPrior>
            <meanParameter>
                <parameter value="0.0"/>
            </meanParameter>
            <priorSampleSize>
                <parameter value="100000.0"/>
            </priorSampleSize>
        </conjugateRootPrior>
        <discretizedBranchRates idref="ancestralTraitTreeDiffusionRates"/>
	</traitDataLikelihood>

	<report>
		New restricted =
		<traitDataLikelihood idref="newRestrictedLikelihood"/>
	</report>

    <assertEqual tolerance="1e-1" verbose="true">
        <message>
            RestrictedPartials vs AncestralTraitTreeModel
        </message>
        <actual regex="logDatumLikelihood:\s+(.*)\n">
            <traitDataLikelihood idref="newRestrictedLikelihood"/>
        </actual>
        <expected regex="logLikelihood:\s*(.*?)\s==">
            <traitDataLikelihood idref="oldRestrictedLikelihood"/>
        </expected>
    </assertEqual>

    <assertEqual tolerance="1e-1" verbose="true">
        <message>
           Vanilla  RestrictedPartials vs AncestralTraitTreeModel
        </message>
        <actual regex="logDatumLikelihood:\s+(.*)\n">
            <traitDataLikelihood idref="newVanillaLikelihood"/>
        </actual>
        <expected regex="logLikelihood:\s*(.*?)\s==">
            <traitDataLikelihood idref="oldVanillaLikelihood"/>
        </expected>
    </assertEqual>

	<operators id="operators">
 		<scaleOperator scaleFactor="0.75" weight="1">
 			<parameter idref="pseudoBranchLengthAB"/>
 		</scaleOperator>

		<uniformOperator weight="1">
			<parameter idref="treeModel.internalNodeHeights"/>
		</uniformOperator>
		<scaleOperator scaleFactor="0.75" weight="1">
			<parameter idref="treeModel.rootHeight"/>
		</scaleOperator>

		<subtreeSlide size="65.0" gaussian="true" weight="15">
			<treeModel idref="treeModel"/>
		</subtreeSlide>

		<narrowExchange weight="15">
			<treeModel idref="treeModel"/>
		</narrowExchange>
		<wideExchange weight="3">
			<treeModel idref="treeModel"/>
		</wideExchange>
		<wilsonBalding weight="3">
			<treeModel idref="treeModel"/>
		</wilsonBalding>

		<scaleOperator scaleFactor="0.75" weight="1">
			<parameter idref="stdev"/>
		</scaleOperator>
		<swapOperator size="1" weight="2" autoOptimize="false">
			<parameter idref="rrwCategories"/>
		</swapOperator>

	</operators>

    <prior id="prior">
        <exponentialPrior mean="0.3333333333333333" offset="0.0">
            <parameter idref="stdev"/>
        </exponentialPrior>
        <booleanLikelihood>
            <monophylyStatistic idref="monophyly(mrcaAB)"/>
        </booleanLikelihood>
    </prior>

	<mcmc id="mcmcNewRestricted" chainLength="2000">
		<posterior id="posteriorNewRestricted">
            <prior idref="prior"/>
			<traitDataLikelihood idref="newRestrictedLikelihood"/>
		</posterior>
		<operators idref="operators"/>
		<log logEvery="10">
			<posterior idref="posteriorNewRestricted"/>
			<traitDataLikelihood idref="newRestrictedLikelihood"/>
		</log>
		<logTree logEvery="10" nexusFormat="true" fileName="testRestrictedTraitLikelihood.trees">
			<traitDataLikelihood idref="newRestrictedLikelihood"/>
			<treeModel idref="ancestralTraitTreeModel"/>
		</logTree>
	</mcmc>

	<report>
        Tree : 
		<treeModel idref="treeModel"/>
	</report>
	<report>
        Ancestral Tree : 
		<ancestralTraitTreeModel idref="ancestralTraitTreeModel"/>
	</report>

	<report>
		New restricted (post MCMC) =
		<traitDataLikelihood idref="newRestrictedLikelihood"/>
	</report>
	<report>
		Old restricted (post MCMC) =
		<multivariateTraitLikelihood idref="oldRestrictedLikelihood"/>
	</report>

    <assertEqual tolerance="1e-1" verbose="true">
        <message>
            RestrictedPartials vs AncestralTraitTreeModel (post MCMC)
        </message>
        <actual regex="logDatumLikelihood:\s+(.*)\n">
            <traitDataLikelihood idref="newRestrictedLikelihood"/>
        </actual>
        <expected regex="logLikelihood:\s*(.*?)\s==">
            <traitDataLikelihood idref="oldRestrictedLikelihood"/>
        </expected>
    </assertEqual>

</beast>
